# 闭包

## 定义

	指有权访问另一个函数作用域中的变量的函数。其表现为可以在外部通过暴露出来的子函数访问其已经被封闭的父函数的作用域；也就是说闭包创建了一个私有的作用域，只能通过暴露出来的函数进行访问、修改其中的变量；

## 特点

* 闭包会引用包含函数的整个活动对象，所以可以通过闭包访问封闭的内部变量
* 局部变量会常驻在内存中
* 可以避免使用全局变量，防止全局污染
* 会造成内存泄漏（有一块内存空间被长期占用，而不被释放）

## 原理

	每次执行函数时，会创建一个执行环境及其响应的作用域链，并把作用域赋值给一个特殊的内部属性（scope），然后使用this、arguments和其他命名参数的值来初始化函数的活动对象。

	作用域链本质上是一个指向变量对象的指针列表，它只引用但不实际包含变量对象

	在一个函数中创建子函数的时候，子函数中的Scope属性保存了父函数的Scope属性引用，所以其活动对象不会被垃圾回收器回收，并且在外部无法访问的此函数中的变量在子函数中可以访问得到，除非将子函数的引用销毁，不然此函数的活动对象不会被销毁

	由于闭包会携带包含它的函数的作用域，因此会比其他函数占用更多的内存。过度使用闭包可能会导致内存占用过多（会产生内存泄漏现象）


## 从词法作用域方面看

	闭包是一个函数和对其周围状态（lexical environment，词法环境）的引用捆绑在一起（或者说函数被引用包围），这样的组合就是闭包（closure）；即闭包可以在内存函数中访问到外层函数的作用域。在javascript中，每当创建一个函数，闭包就会在函数创建时被创建出来；

	词法根据源代码中声明变量的位置来确定该变量在何处可用。嵌套函数可访问声明于它们外部作用域的变量

## 内存泄漏

### 定义

	内存泄漏（Memory Leak） 是指程序中已动态分配的堆内存由于某种原因程序未释放或无法释放，造成系统内存的浪费，导致程序运行速度减慢甚至系统崩溃等严重后果

### 特点

	内存泄漏缺陷具有隐蔽性、积累性的特征，比其他内存非法访问错误更难检测。因为内存泄漏的产生原因是内存块未被释放，属于遗漏型缺陷而不是过错型缺陷

### 内存泄漏在javascript中的体现

	当闭包被销毁时，其引用的活动对象并没有被销毁；或者当某个闭包对象已经不使用，但也没有把引用闭包对象的变量赋值null手动释放内存；

例子如下：

```javascript
function func(){
	var newElem;
	function outer(){
		var someTet = new Array(100000);
		var elem = newElem;
		function inner(){
			if(elem) return someText;
		}
		function f(){}
		return f
	}
	setInterval(function(){
		newElem = outer();
	},500)
}
func();
```

闭包内存泄漏为：key = value，key被删除了value常驻内存中；局部变量闭包升级版（中间引用的变量）=> 自由变量；


